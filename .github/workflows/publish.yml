name: Publish to npm

on:
  # 手动触发（可选输入 version）
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 0.1.1). If set, will override package.json version for this run.'
        required: false
        type: string

  push:
    tags:
      - 'v*' # 只要推送到 GitHub 的 tag 是以 v 开头的（如 v0.1.0），就触发

jobs:
  publish:
    runs-on: ubuntu-latest
    
    # 权限设置（读取代码）
    permissions:
      contents: read

    steps:
      # 1. 把代码拉下来
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装 Node.js 环境
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # 3. 安装 pnpm (因为你的项目用的是 pnpm)
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # 4. 修复 pnpm-lock.yaml 中的内部镜像 tarball（r.npm.sankuai.com）
      #    注意：lockfile 里出现的是镜像的 /download/ 路径，不能“换域名”直接变成 npm 官方可用 URL。
      #    这里做法是：移除这些 tarball 字段，让 pnpm 使用 registry 重新解析生成正确的 tarball。
      - name: Fix lockfile tarball urls
        run: |
          node -e "const fs=require('fs'); const p='pnpm-lock.yaml'; let s=fs.readFileSync(p,'utf8'); s=s.replace(/,\\s*tarball:\\s*https?:\\/\\/r\\.npm\\.sankuai\\.com[^}]+/g,''); s=s.replace(/^\\s*tarball:\\s*https?:\\/\\/r\\.npm\\.sankuai\\.com.*\\n/gm,''); fs.writeFileSync(p,s);"

      # 5. workflow_dispatch 时覆盖版本号（不提交回仓库，仅用于本次 publish）
      - name: Update version from input
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version != '' }}
        run: |
          node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json','utf8')); pkg.version='${{ github.event.inputs.version }}'; fs.writeFileSync('package.json', JSON.stringify(pkg,null,2)+'\n');"

      # 6. 安装依赖（强制使用官方 npm registry，并允许重写 lockfile 到官方 tarball）
      - name: Install Dependencies
        env:
          NPM_CONFIG_REGISTRY: https://registry.npmjs.org/
          PNPM_CONFIG_REGISTRY: https://registry.npmjs.org/
        run: |
          pnpm config set registry https://registry.npmjs.org/
          pnpm install --no-frozen-lockfile

      # 7. 代码检查 & 测试 (发布前必须保证代码是好的)
      - name: Lint & Test
        run: |
          pnpm lint
          pnpm test

      # 8. 打包构建
      - name: Build
        run: pnpm build

      # 9. 发布到 npm
      # 这一步会自动读取你的 package.json 里的版本号发布
      - name: Publish
        env:
          # 这里引用你在 GitHub 后台设置的 Secret
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "NPM_TOKEN is not set. Please add it in GitHub repo Settings -> Secrets and variables -> Actions."
            exit 1
          fi

          # Explicit npm auth for npm publish (avoid ENEEDAUTH)
          cat > ~/.npmrc <<'EOF'
          registry=https://registry.npmjs.org/
          always-auth=true
          //registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}
          EOF

          npm whoami
          npm publish --access public
